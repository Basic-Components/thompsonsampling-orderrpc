# thompsonsampling-orderrpc

汤普森采样的通用服务,用于从redis中获得目标物品的alpha,beta值,然后过beta分布随机出一个数值后做排序

## 状态保存

redis中的key模板为`Tompsonsampling::{业务命名空间}::{目标命名空间}::{候选物品}`,类型为`hash`,且hash中只有`alpha`和`beta`两个字段

如果找不到则默认为`0`

业务命名空间和目标命名空间默认为`__global__`

状态读写都使用原子操作因此不需要用分布式锁

## 使用

这是一个独立的微服务,需要连接一个redis用于水平扩展时作为共享状态的保存位置.请不要直接使用连接的redis来修改参数状态.要修改状态请调用`Update`接口.

注意更新请求中的ttl为key的过期时间,默认值由启动参数`DefaultKeyTTL`来控制,它是防止redis的key忘记删除而设置的,在每次update后都会刷新.

`Update`接口会维护一个metakey用于存放每个业务的每个目标其下面更新过的候选人(不会因为过期而删除其中的内容,但这个key本生会过期,遵从ttl设置)

`Update`接口有两种模式

1. 重置模式, 将key的值重置为指定的值,注意也会重置meta中的候选集
2. 增量模式, 将key的值与提供的增量叠加

建议更多的使用重置模式,以确保事件的时效性.具体就是按固定的周期或者总量批量的的重置参数